# Seat-Select Worker Deployment Configuration
# 内网服务器部署 - Celery Worker
# ==============================================================================

# ==================== Shared Environment Variables ====================
x-worker-common-env: &worker-common-env
  # Redis & Celery
  REDIS_URL: ${REDIS_URL}
  
  # Supabase
  SUPABASE_URL: ${SUPABASE_URL}
  SUPABASE_KEY: ${SUPABASE_KEY}
  
  # Gmail Configuration
  GMAIL_CREDENTIALS_PATH: /app/src/utils/gmail/creds/credentials.json
  GMAIL_TOKEN_PATH: /app/src/utils/gmail/creds/token.pickle
  ETRANSFER_RECEIVE_EMAIL: ${ETRANSFER_RECEIVE_EMAIL}
  
  # System Configuration
  RESERVATION_EXPIRY_HOURS: ${RESERVATION_EXPIRY_HOURS:-24}
  CORS_ORIGINS: ${CORS_ORIGINS}

# ==================== Networks & Volumes ====================
networks:
  seat-select-network:
    driver: bridge

volumes:
  redis_data:
    driver: local

# ==================== Services ====================
services:
  # ==================== Redis (Local cache if needed, or connect to cloud) ====================
  # 如果内网服务器也运行 Redis 镜像，可以保留；如果直接连外部 Redis，则可以删除此服务
  redis:
    image: redis:7-alpine
    container_name: seat-select-redis
    networks:
      - seat-select-network
    volumes:
      - redis_data:/data
    restart: unless-stopped

  # ==================== Celery Worker ====================
  worker:
    image: ${REGISTRY_URL:-registry.woohelps.com}/seat-select/backend:${VERSION:-latest}
    container_name: seat-select-worker
    restart: always
    networks:
      - seat-select-network
    depends_on:
      - redis
    volumes:
      - ./src/utils/gmail/creds:/app/src/utils/gmail/creds
    environment:
      <<: *worker-common-env
    command: celery -A celery_app.celery worker --loglevel=info

    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

    healthcheck:
      test: ["CMD-SHELL", "celery -A celery_app.celery inspect ping"]
      interval: 60s
      timeout: 30s
      retries: 3

  # ==================== Celery Beat ====================
  celery-beat:
    image: ${REGISTRY_URL:-registry.woohelps.com}/seat-select/backend:${VERSION:-latest}
    container_name: seat-select-beat
    restart: always
    networks:
      - seat-select-network
    depends_on:
      - redis
    volumes:
      - ./src/utils/gmail/creds:/app/src/utils/gmail/creds
    environment:
      <<: *worker-common-env
    command: celery -A celery_app.celery beat --loglevel=info

